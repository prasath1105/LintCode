### 325.Football

考虑球队i赢得总决赛的概率是多少？等于球队i赢得半决赛的概率，乘以对手j赢得半决赛的概率，乘以球队i能赢球队j的概率。其中对手j是谁我们并不确定，需要遍历一遍。因此
```
P(i赢得总决赛) = P(i赢得半决赛) * (P(j1赢得半决赛)*P(i能赢j1的概率) + P(j2赢得半决赛)*P(i能赢j2的概率) + ... + P(j8赢得半决赛)*P(i能赢j8的概率) )
```
注意，i在总决赛中的对手只可能有8种可能，并且j1,j2,...,j8一定是在不同的半区。

从上面的式子我们可以看出，求某个球队赢得总决赛的概率，转化为了若干个队伍赢得半决赛的概率。同理，我们要求某个队伍赢得半决赛的概率，势必要求出若干个队伍赢得四分之一决赛的概率。以此类推，我们必须提前算出每支队伍赢得每一个阶段的概率。

那么怎么来表示“某支队伍赢得某一个阶段”的概率呢？其实可以有很多种方法。比如说，我们设计dp[i][j][k]表示在球队区间[i,i+j-1]内，第k支球队（相对于第i支球队）赢得区间冠军的概率。i表示这个区间的第一支球队，j表示这个区间的大小。比如说i=0,j=16，对应的就是在全部队伍里取得总冠军。i=0,j=8，就意味着在前8支队伍里取得半决赛冠军。i=8,j=8,就意味着在后8支队里取得半决赛冠军。i=4,j=4，表示在第二个四分之一赛区取得该赛区的冠军。

举个例子，球队3赢得总冠军的概率是dp[0][16][3]，球队4赢得半决赛的概率是dp[0][8][4], 球队8赢得半决赛的概率是dp[8][8][0]，球队11赢得第一轮比赛的概率是dp[10][2][1]. 可见区间[i,i+j-1]就代表了比赛的性质（总决赛，半决赛，四分之一决赛...），并且这个区间大小总是2的倍数。另外，k必须小于j。

需要说明的是，i,j,k之间有着上述的很多制约因素，因此用三个下标来表示dp的状态其实是冗余的。但操作起来比较方便。

考虑dp[i][j][k]，即球队i+k在[i,i+j-1]这个区间内多的第一名的概率。我们首先要判断的是k在这个区间内部属于哪个半区。如果是前半区，那么它从前半区内脱颖而出的概率就是dp[i][j/2][k]。那么它在这个区间内的最后一个对手就可能是i+j/2, i+j/2+1, ... i+j-1.这些对手都可能是另外一个半区的冠军，所以球队i+k赢得这个区间的概率就是：
```
dp[i][j][k] = dp[i][j/2][k] * (dp[i+j/2][j/2][0] * p[i+k][i+j/2] +  dp[i+j/2][j/2][1] * p[i+k][i+j/2+1], + ... + dp[i+j/2][j/2][j/2-1] * p[i+k][i+j-1])
                           后半区第一支队伍赢得后半区冠军           后半区第二支队伍赢得后半区冠军                  后半区最后一支队伍赢得后半区冠军
```
同理，如果k在这个区间内是在后半区，我们可以调整上式，在前半区遍历它的对手。

边界条件是dp[i][1][0]=1，表示任何一个球队自己单独组成一个区间，那么晋级概率必然是1.

最终总冠军概率最大的球队，是dp[0][16][x]里面的最大值所对应的x，x的范围就是0到15.
